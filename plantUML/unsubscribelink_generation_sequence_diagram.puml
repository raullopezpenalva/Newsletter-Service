@startuml unsubscribeLink_generation_sequence_diagram
entity "NewsletterEmailSenderService" as EmailSenderService

participant "NewsletterController" as Controller
participant "NewsletterService" as Service
participant "TokenService" as TokenService
participant "EmailService" as EmailService
participant "SubscriberRepository" as Repo
participant "VerificationTokenRepository" as TokenRepo

actor Usuario

EmailSenderService -> Controller : GET All Active Subscribers
activate EmailSenderService
activate Controller
Controller -> Service : getAllActiveSubscribers()
activate Service
Service -> Repo : findAllByStatus(ACTIVE)
activate Repo
Repo --> Service : return List<Subscriber>
deactivate Repo
Service --> Controller : return List<Subscriber>
deactivate Service
Controller --> EmailSenderService : return List<Subscriber>
deactivate Controller

EmailSenderService -> Controller : GET /getUnsubscribeLink (email)
activate Controller
Controller -> Service : generateUnsubscribeLink(email)
activate Service
Service -> Repo : findByEmail(email) with status=ACTIVE
activate Repo
Repo --> Service : return Subscriber
deactivate Repo
Service -> TokenService : generates the UNSUBSCRIBE token
activate TokenService
TokenService -> TokenRepo : save the token
TokenService -> Service : return generated Token
deactivate TokenService
Service -> EmailService : generatedUnsubscribeLink(token)
activate EmailService
EmailService --> Service : return unsubscribe link
deactivate EmailService
Service --> Controller : return unsubscribe link
deactivate Service
Controller --> EmailSenderService : return unsubscribe link
deactivate Controller
EmailSenderService -> Usuario : Sends newsletters emails with personal unsubscribe link 
deactivate EmailSenderService

@enduml